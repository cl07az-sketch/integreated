#!/usr/bin/env python3
# Button toggles monitoring ON/OFF (interrupt-based, always works)
# Continuous buzzer if water + <80°F
# Repeating 2-second buzzer pulses if only <80°F
# Vibrator ON when water is detected
# Camera prints description of scene every capture

import RPi.GPIO as GPIO
import time
import os
import glob
import subprocess
import base64
from openai import OpenAI

# -------------------- GPIO CONFIG --------------------
BuzzerPin = 11
ButtonPin = 13
VIBRATOR_PIN = 22

monitoring = True

def setup():
    GPIO.setmode(GPIO.BOARD)

    GPIO.setup(BuzzerPin, GPIO.OUT)
    GPIO.output(BuzzerPin, GPIO.HIGH)

    GPIO.setup(ButtonPin, GPIO.IN, pull_up_down=GPIO.PUD_UP)

    GPIO.setup(VIBRATOR_PIN, GPIO.OUT)
    GPIO.output(VIBRATOR_PIN, GPIO.HIGH)

    GPIO.add_event_detect(ButtonPin, GPIO.FALLING, callback=toggle_monitoring, bouncetime=200)

def toggle_monitoring(channel):
    global monitoring
    monitoring = not monitoring
    print("\nMonitoring RESUMED." if monitoring else "\nMonitoring PAUSED.")
    if not monitoring:
        buzzer_off()
        vibrator_off()

def buzzer_on():
    GPIO.output(BuzzerPin, GPIO.LOW)

def buzzer_off():
    GPIO.output(BuzzerPin, GPIO.HIGH)

def vibrator_on():
    GPIO.output(VIBRATOR_PIN, GPIO.HIGH)

def vibrator_off():
    GPIO.output(VIBRATOR_PIN, GPIO.LOW)

def cleanup():
    GPIO.cleanup()

# -------------------- TEMP SENSOR --------------------
os.system('modprobe w1-gpio')
os.system('modprobe w1-therm')

base_dir = '/sys/bus/w1/devices/'
device_folder = glob.glob(base_dir + '28*')[0]
device_file = device_folder + '/w1_slave'

def read_temp_raw():
    with open(device_file, 'r') as f:
        return f.readlines()

def read_temp():
    lines = read_temp_raw()
    while lines[0].strip()[-3:] != 'YES':
        time.sleep(0.2)
        lines = read_temp_raw()
    t = lines[1].split('t=')[1]
    c = float(t)/1000.0
    return c, c*9/5+32

# -------------------- CAMERA + OPENAI --------------------
client = OpenAI(api_key="sk-REPLACE_WITH_NEW_KEY")

MODEL = "gpt-5-nano-2025-08-07"
IMAGE_PATH = "captured_image.jpg"
RESOLUTION = "640x480"

def capture_image(path):
    subprocess.run(["fswebcam", "-r", RESOLUTION, "-S", "2", "--no-banner", path], check=True)

def to_data_url(path):
    with open(path, "rb") as f:
        return "data:image/jpeg;base64," + base64.b64encode(f.read()).decode()

def extract_text(resp):
    text = getattr(resp, "output_text", None)
    if text:
        return text.strip()
    try:
        for item in resp.output:
            for part in item.content:
                if getattr(part, "text", None):
                    return part.text.strip()
    except:
        pass
    return ""

def analyze_for_water():
    prompt = (
        "Describe the image in one or two sentences. Then on the last line output ONLY 'YES' if water "
        "is visible, otherwise 'NO'."
    )

    resp = client.responses.create(
        model=MODEL,
        max_output_tokens=80,
        input=[{
            "role": "user",
            "content": [
                {"type": "input_text", "text": prompt},
                {"type": "input_image", "image_url": to_data_url(IMAGE_PATH)}
            ]
        }],
    )

    raw = extract_text(resp)
    lines = raw.strip().split("\n")
    yesno = lines[-1].strip().upper()
    description = "\n".join(lines[:-1]).strip()
    return yesno.startswith("Y"), description


# -------------------- MAIN LOOP --------------------
def main():
    global monitoring
    print("System started. Press button to toggle ON/OFF.")

    last_camera_time = 0
    camera_interval = 5
    has_water = False
    buzzer_end_time = 0

    while True:
        if monitoring:

            # Temp
            try:
                _, temp_f = read_temp()
                print(f"Temperature: {temp_f:.2f} °F", end="\r")
            except:
                temp_f = 72

            # Camera every interval
            if time.time() - last_camera_time >= camera_interval:
                capture_image(IMAGE_PATH)
                print("\nImage captured — analyzing...")
                has_water, description = analyze_for_water()
                print("\nImage description:")
                print(description)
                print("\nWATER DETECTED" if has_water else "\nNO WATER DETECTED")
                vibrator_on() if has_water else vibrator_off()
                last_camera_time = time.time()

            # ---- BUZZER LOGIC (REPEATING PULSE CORRECTED) ----
            if temp_f < 75:
                if has_water:
                    buzzer_on()
                    buzzer_end_time = 0
                else:
                    if time.time() < buzzer_end_time:
                        buzzer_on()
                    else:
                        buzzer_off()
                        buzzer_end_time = time.time() + 2 if buzzer_end_time == 0 or time.time() >= buzzer_end_time else buzzer_end_time
            else:
                buzzer_off()
                buzzer_end_time = 0

        else:
            buzzer_off()
            vibrator_off()

        time.sleep(0.05)

# -------------------- ENTRY POINT --------------------
if __name__ == "__main__":
    setup()
    print("Vibrator initialized.")
    try:
        main()
    except KeyboardInterrupt:
        print("\nProgram interrupted. Cleaning up...")
        cleanup()

